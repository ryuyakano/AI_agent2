{% extends "base.html" %}

{% block title %}å¥‘ç´„æ›¸å“è³ªè©•ä¾¡ - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†AI Agent{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ¤– LLM-as-a-Judge å¥‘ç´„æ›¸å“è³ªè©•ä¾¡</h2>
            <div>
                <a href="/contracts" class="btn btn-outline-primary">ğŸ“š ä¸€è¦§è¡¨ç¤º</a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        {% if contracts %}
        <form method="post" action="/evaluate">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>ğŸ“‹ è©•ä¾¡å¯¾è±¡å¥‘ç´„æ›¸ã®é¸æŠ</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="file_name" class="form-label">å¥‘ç´„æ›¸ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
                        <select class="form-select" id="file_name" name="file_name" required>
                            <option value="">-- å¥‘ç´„æ›¸ã‚’é¸æŠ --</option>
                            {% for contract in contracts %}
                            <option value="{{ contract.file_path.split('/')[-1] }}" 
                                    data-type="{{ contract.type }}"
                                    data-created="{{ contract.metadata.created_at[:19].replace('T', ' ') }}">
                                {% if contract.type == 'rental' %}
                                    ğŸ  {{ contract.metadata.property_name }} ({{ contract.metadata.created_at[:10] }})
                                {% else %}
                                    ğŸ“‹ {{ contract.metadata.service_description[:30] }}... ({{ contract.metadata.created_at[:10] }})
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">è©•ä¾¡ã—ãŸã„å¥‘ç´„æ›¸ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                    </div>
                    
                    <div class="selected-contract-info" id="contractInfo" style="display: none;">
                        <div class="alert alert-info">
                            <h6>ğŸ“„ é¸æŠã•ã‚ŒãŸå¥‘ç´„æ›¸</h6>
                            <div id="contractDetails"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="/contracts" class="btn btn-secondary me-md-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
                <button type="submit" class="btn btn-primary">
                    ğŸ¤– AIè©•ä¾¡ã‚’å®Ÿè¡Œ
                </button>
            </div>
        </form>
        {% else %}
        <div class="alert alert-warning text-center">
            <h4>ğŸ“­ è©•ä¾¡å¯èƒ½ãªå¥‘ç´„æ›¸ãŒã‚ã‚Šã¾ã›ã‚“</h4>
            <p>å¥‘ç´„æ›¸ã‚’ä½œæˆã—ã¦ã‹ã‚‰è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
            <div class="mt-3">
                <a href="/rental" class="btn btn-primary me-2">ğŸ  è³ƒè²¸å¥‘ç´„æ›¸ã‚’ä½œæˆ</a>
                <a href="/service" class="btn btn-success">ğŸ“‹ æ¥­å‹™å§”è¨—å¥‘ç´„æ›¸ã‚’ä½œæˆ</a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6>ğŸ¤– LLM-as-a-Judge ã¨ã¯</h6>
            </div>
            <div class="card-body">
                <p class="small">
                    æœ€æ–°ã®AIæŠ€è¡“ã‚’ä½¿ç”¨ã—ã¦ã€å¥‘ç´„æ›¸ã®å“è³ªã‚’å®¢è¦³çš„ã«è©•ä¾¡ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚
                    OpenAIã®GPT-4ã‚’ä½¿ç”¨ã—ã¦ã€æ³•çš„ãªè¦³ç‚¹ã‹ã‚‰å¥‘ç´„æ›¸ã‚’åˆ†æã—ã¾ã™ã€‚
                </p>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6>ğŸ“Š è©•ä¾¡é …ç›®</h6>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li><strong>æ³•çš„é©åˆæ€§:</strong> æ—¥æœ¬æ³•ã¸ã®æº–æ‹ åº¦</li>
                    <li><strong>æƒ…å ±å®Œæ•´æ€§:</strong> å¿…è¦æ¡é …ã®ç¶²ç¾…æ€§</li>
                    <li><strong>æ˜ç­æ€§:</strong> æ¡æ–‡ã®ç†è§£ã—ã‚„ã™ã•</li>
                    <li><strong>ãƒªã‚¹ã‚¯ç®¡ç†:</strong> åŒæ–¹ã®ãƒªã‚¹ã‚¯é…æ…®</li>
                    <li><strong>å®Ÿç”¨æ€§:</strong> å®Ÿéš›ã®é‹ç”¨ã«ãŠã‘ã‚‹æœ‰åŠ¹æ€§</li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6>ğŸ” è©•ä¾¡çµæœã®è©³ç´°</h6>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li><strong>ç·åˆã‚¹ã‚³ã‚¢:</strong> 1-100ç‚¹ã§ã®è©•ä¾¡</li>
                    <li><strong>é …ç›®åˆ¥ã‚¹ã‚³ã‚¢:</strong> å„è©•ä¾¡é …ç›®ã®è©³ç´°ç‚¹æ•°</li>
                    <li><strong>å¼·ã¿ã¨å¼±ç‚¹:</strong> å¥‘ç´„æ›¸ã®è‰¯ã„ç‚¹ãƒ»æ”¹å–„ç‚¹</li>
                    <li><strong>æ”¹å–„ææ¡ˆ:</strong> å…·ä½“çš„ãªæ”¹å–„æ–¹æ³•</li>
                    <li><strong>æ³•çš„æ‡¸å¿µç‚¹:</strong> æ³¨æ„ã™ã¹ãæ³•çš„å•é¡Œ</li>
                    <li><strong>ç·åˆè©•ä¾¡:</strong> A-Fæ®µéšã§ã®æ ¼ä»˜ã‘</li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6>ğŸ“ˆ LangFuse ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°</h6>
            </div>
            <div class="card-body">
                <p class="small">
                    ã™ã¹ã¦ã®è©•ä¾¡ãƒ—ãƒ­ã‚»ã‚¹ã¯LangFuseã§ç›£è¦–ãƒ»è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚
                    è©•ä¾¡çµæœã¨å…±ã«ãƒˆãƒ¬ãƒ¼ã‚¹IDãŒæä¾›ã•ã‚Œã€è©³ç´°ãªåˆ†æãŒå¯èƒ½ã§ã™ã€‚
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ä¸€æ‹¬è©•ä¾¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>ğŸš€ ä¸€æ‹¬è©•ä¾¡æ©Ÿèƒ½</h5>
            </div>
            <div class="card-body">
                <p>è¤‡æ•°ã®å¥‘ç´„æ›¸ã‚’ä¸€åº¦ã«è©•ä¾¡ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</p>
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100" onclick="batchEvaluate('all')">
                            ğŸ“Š ã™ã¹ã¦ã®å¥‘ç´„æ›¸ã‚’ä¸€æ‹¬è©•ä¾¡
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="batchEvaluate('rental')">
                            ğŸ  è³ƒè²¸å¥‘ç´„æ›¸ã®ã¿
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" onclick="batchEvaluate('service')">
                            ğŸ“‹ æ¥­å‹™å§”è¨—å¥‘ç´„æ›¸ã®ã¿
                        </button>
                    </div>
                </div>
                <div id="batchResults" class="mt-3" style="display: none;">
                    <!-- ä¸€æ‹¬è©•ä¾¡çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰äº‹å‰é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š
document.addEventListener('DOMContentLoaded', function() {
    {% if preselected_file %}
    const preselectedFile = '{{ preselected_file }}';
    const selectElement = document.getElementById('file_name');
    
    // è©²å½“ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
    for (let option of selectElement.options) {
        if (option.value === preselectedFile) {
            option.selected = true;
            // è©³ç´°æƒ…å ±ã‚‚è¡¨ç¤º
            selectElement.dispatchEvent(new Event('change'));
            break;
        }
    }
    {% endif %}
});
// å¥‘ç´„æ›¸é¸æŠæ™‚ã®è©³ç´°è¡¨ç¤º
document.getElementById('file_name').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const contractInfo = document.getElementById('contractInfo');
    const contractDetails = document.getElementById('contractDetails');
    
    if (selectedOption.value) {
        const type = selectedOption.getAttribute('data-type');
        const created = selectedOption.getAttribute('data-created');
        const fileName = selectedOption.value;
        
        contractDetails.innerHTML = `
            <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> <code>${fileName}</code></p>
            <p><strong>ç¨®é¡:</strong> ${type === 'rental' ? 'ğŸ  è³ƒè²¸å¥‘ç´„æ›¸' : 'ğŸ“‹ æ¥­å‹™å§”è¨—å¥‘ç´„æ›¸'}</p>
            <p><strong>ä½œæˆæ—¥æ™‚:</strong> ${created}</p>
            <p><strong>é¸æŠå†…å®¹:</strong> ${selectedOption.text}</p>
        `;
        contractInfo.style.display = 'block';
    } else {
        contractInfo.style.display = 'none';
    }
});

// ä¸€æ‹¬è©•ä¾¡æ©Ÿèƒ½
async function batchEvaluate(contractType) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ è©•ä¾¡ä¸­...';
    btn.disabled = true;
    
    try {
        const params = contractType === 'all' ? '' : `?contract_type=${contractType}`;
        const response = await fetch(`/api/batch-evaluate${params}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayBatchResults(data.evaluations);
        } else {
            alert('ä¸€æ‹¬è©•ä¾¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + data.message);
        }
        
    } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function displayBatchResults(evaluations) {
    const resultsDiv = document.getElementById('batchResults');
    
    let html = '<div class="alert alert-success"><h6>ğŸ‰ ä¸€æ‹¬è©•ä¾¡ãŒå®Œäº†ã—ã¾ã—ãŸ</h6></div>';
    html += '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>å¥‘ç´„æ›¸</th><th>ç·åˆã‚¹ã‚³ã‚¢</th><th>è©•ä¾¡</th><th>ãƒˆãƒ¬ãƒ¼ã‚¹ID</th></tr></thead><tbody>';
    
    evaluations.forEach(evaluation => {
        if (evaluation.success) {
            const fileName = evaluation.file_path.split('/').pop();
            const score = evaluation.evaluation.overall_score;
            const grade = evaluation.evaluation.grade;
            const traceId = evaluation.trace_id;
            
            html += `<tr>
                <td><code>${fileName}</code></td>
                <td><span class="badge ${getScoreBadgeClass(score)}">${score}ç‚¹</span></td>
                <td><span class="badge ${getGradeBadgeClass(grade)}">${grade}</span></td>
                <td><small><code>${traceId}</code></small></td>
            </tr>`;
        } else {
            const fileName = evaluation.file_path.split('/').pop();
            html += `<tr>
                <td><code>${fileName}</code></td>
                <td><span class="badge bg-danger">ã‚¨ãƒ©ãƒ¼</span></td>
                <td>-</td>
                <td><small>${evaluation.error}</small></td>
            </tr>`;
        }
    });
    
    html += '</tbody></table></div>';
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
}

function getScoreBadgeClass(score) {
    if (score >= 80) return 'bg-success';
    if (score >= 60) return 'bg-warning';
    return 'bg-danger';
}

function getGradeBadgeClass(grade) {
    if (grade === 'A') return 'bg-success';
    if (grade === 'B') return 'bg-primary';
    if (grade === 'C') return 'bg-warning';
    return 'bg-danger';
}

// ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
document.querySelector('form').addEventListener('submit', function(e) {
    const fileName = document.getElementById('file_name').value;
    
    if (!fileName) {
        e.preventDefault();
        alert('è©•ä¾¡ã™ã‚‹å¥‘ç´„æ›¸ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    // è©•ä¾¡å®Ÿè¡Œç¢ºèª
    if (!confirm('é¸æŠã—ãŸå¥‘ç´„æ›¸ã®AIè©•ä¾¡ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\\n\\nè©•ä¾¡ã«ã¯æ•°åç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
        e.preventDefault();
        return;
    }
});
</script>
{% endblock %}