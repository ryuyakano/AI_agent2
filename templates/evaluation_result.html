{% extends "base.html" %}

{% block title %}è©•ä¾¡çµæœ - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†AI Agent{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        {% if success %}
            <div class="alert alert-success">
                <h4>ğŸ¤– AIè©•ä¾¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h4>
                <p class="mb-0">å¥‘ç´„æ›¸ã€Œ<code>{{ file_name }}</code>ã€ã®å“è³ªè©•ä¾¡çµæœ</p>
                {% if trace_id %}
                <small>LangFuse Trace ID: <code>{{ trace_id }}</code></small>
                {% endif %}
            </div>
        {% else %}
            <div class="alert alert-danger">
                <h4>âŒ è©•ä¾¡ã‚¨ãƒ©ãƒ¼</h4>
                <p class="mb-0">{{ error }}</p>
            </div>
        {% endif %}
    </div>
</div>

{% if success and evaluation %}
<div class="row">
    <!-- ç·åˆè©•ä¾¡ã‚«ãƒ¼ãƒ‰ -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5>ğŸ“Š ç·åˆè©•ä¾¡</h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-3">
                    <h1 class="display-1 text-{{ evaluation.overall_score >= 80 and 'success' or (evaluation.overall_score >= 60 and 'warning' or 'danger') }}">
                        {{ evaluation.overall_score }}
                    </h1>
                    <p class="lead">ç·åˆã‚¹ã‚³ã‚¢ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰</p>
                </div>
                <div class="mb-3">
                    <span class="badge fs-3 bg-{{ evaluation.grade == 'A' and 'success' or (evaluation.grade == 'B' and 'primary' or (evaluation.grade == 'C' and 'warning' or 'danger')) }}">
                        è©•ä¾¡: {{ evaluation.grade }}
                    </span>
                </div>
                <p class="text-muted">{{ evaluation.summary }}</p>
            </div>
        </div>
    </div>
    
    <!-- é …ç›®åˆ¥ã‚¹ã‚³ã‚¢ -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5>ğŸ“ˆ é …ç›®åˆ¥ã‚¹ã‚³ã‚¢</h5>
            </div>
            <div class="card-body">
                {% for key, value in evaluation.scores.items() %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>
                            {% if key == 'legal_compliance' %}ğŸ“œ æ³•çš„é©åˆæ€§
                            {% elif key == 'completeness' %}ğŸ“‹ å®Œæ•´æ€§
                            {% elif key == 'clarity' %}ğŸ’¡ æ˜ç­æ€§
                            {% elif key == 'risk_management' %}âš–ï¸ ãƒªã‚¹ã‚¯ç®¡ç†
                            {% elif key == 'practicality' %}ğŸ”§ å®Ÿç”¨æ€§
                            {% else %}{{ key }}
                            {% endif %}
                        </span>
                        <span class="fw-bold">{{ value }}/10</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-{{ value >= 8 and 'success' or (value >= 6 and 'warning' or 'danger') }}" 
                             style="width: {{ value * 10 }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- å¼·ã¿ã¨å¼±ç‚¹ -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5>ğŸ’ª å¼·ã¿</h5>
            </div>
            <div class="card-body">
                {% if evaluation.strengths %}
                <ul class="list-unstyled">
                    {% for strength in evaluation.strengths %}
                    <li class="mb-2">
                        <i class="text-success">âœ…</i> {{ strength }}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">ç‰¹è¨˜ã™ã¹ãå¼·ã¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5>âš ï¸ å¼±ç‚¹ãƒ»æ”¹å–„ç‚¹</h5>
            </div>
            <div class="card-body">
                {% if evaluation.weaknesses %}
                <ul class="list-unstyled">
                    {% for weakness in evaluation.weaknesses %}
                    <li class="mb-2">
                        <i class="text-warning">âš ï¸</i> {{ weakness }}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">ç‰¹è¨˜ã™ã¹ãå¼±ç‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- æ”¹å–„ææ¡ˆ -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5>ğŸ’¡ æ”¹å–„ææ¡ˆ</h5>
            </div>
            <div class="card-body">
                {% if evaluation.recommendations %}
                <ol>
                    {% for recommendation in evaluation.recommendations %}
                    <li class="mb-2">{{ recommendation }}</li>
                    {% endfor %}
                </ol>
                {% else %}
                <p class="text-muted">è¿½åŠ ã®æ”¹å–„ææ¡ˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- æ³•çš„æ‡¸å¿µç‚¹ -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-danger text-white">
                <h5>âš–ï¸ æ³•çš„æ‡¸å¿µç‚¹</h5>
            </div>
            <div class="card-body">
                {% if evaluation.legal_issues %}
                <ul class="list-unstyled">
                    {% for issue in evaluation.legal_issues %}
                    <li class="mb-2">
                        <i class="text-danger">âš–ï¸</i> {{ issue }}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="alert alert-success">
                    <i class="text-success">âœ…</i> é‡å¤§ãªæ³•çš„æ‡¸å¿µç‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- LangFuse ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ± -->
{% if trace_id %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>ğŸ“Š LangFuse ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±</h5>
            </div>
            <div class="card-body">
                <p><strong>ãƒˆãƒ¬ãƒ¼ã‚¹ID:</strong> <code>{{ trace_id }}</code></p>
                <p class="text-muted">
                    ã“ã®è©•ä¾¡ãƒ—ãƒ­ã‚»ã‚¹ã¯LangFuseã§ç›£è¦–ãƒ»è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚
                    è©³ç´°ãªåˆ†æã‚„ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã¯LangFuseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç¢ºèªã§ãã¾ã™ã€‚
                </p>
                <a href="http://localhost:3000" target="_blank" class="btn btn-outline-primary">
                    ğŸ”— LangFuseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

<!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <a href="/evaluate" class="btn btn-primary">ğŸ¤– åˆ¥ã®å¥‘ç´„æ›¸ã‚’è©•ä¾¡</a>
            <a href="/contracts" class="btn btn-outline-primary">ğŸ“š å¥‘ç´„æ›¸ä¸€è¦§ã«æˆ»ã‚‹</a>
            <a href="/" class="btn btn-outline-secondary">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
            {% if success and evaluation %}
            <button class="btn btn-outline-success" onclick="exportEvaluation()">ğŸ“¥ è©•ä¾¡çµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            {% endif %}
        </div>
    </div>
</div>

{% if not success %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6>ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h6>
            </div>
            <div class="card-body">
                <p>è©•ä¾¡ã«å¤±æ•—ã—ãŸå ´åˆã®å¯¾å‡¦æ³•ï¼š</p>
                <ul>
                    <li>å¥‘ç´„æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª</li>
                    <li>OpenAI APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª</li>
                    <li>LangFuseã‚µãƒ¼ãƒ“ã‚¹ãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª</li>
                    <li>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª</li>
                </ul>
                <p>å•é¡ŒãŒç¶šãå ´åˆã¯ã€ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
{% if success and evaluation %}
// è©•ä¾¡çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
function exportEvaluation() {
    const evaluation = {{ evaluation | tojson | safe }};
    const fileName = '{{ file_name }}';
    const traceId = '{{ trace_id }}';
    
    const exportData = {
        file_name: fileName,
        trace_id: traceId,
        evaluation_date: new Date().toISOString(),
        evaluation: evaluation
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `evaluation_${fileName}_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
    link.click();
}

// ã‚¹ã‚³ã‚¢å¯è¦–åŒ–ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.transition = 'width 1s ease-in-out';
            bar.style.width = width;
        }, 500);
    });
});

// ç·åˆã‚¹ã‚³ã‚¢ã®æ•°å€¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
const scoreElement = document.querySelector('.display-1');
if (scoreElement) {
    const finalScore = {{ evaluation.overall_score }};
    let currentScore = 0;
    const increment = finalScore / 30;
    
    const timer = setInterval(() => {
        currentScore += increment;
        if (currentScore >= finalScore) {
            currentScore = finalScore;
            clearInterval(timer);
        }
        scoreElement.textContent = Math.round(currentScore);
    }, 50);
}

console.log('LangFuse Trace ID: {{ trace_id }}');
{% endif %}
</script>
{% endblock %}